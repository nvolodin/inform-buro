!function(){"use strict";angular.module("informBuroApp",["ngRoute","informBuroApp.core"]).config(["$routeProvider","$locationProvider",function(a,b){b.hashPrefix("!"),a.when("/search/:drug",{templateUrl:"views/search.html",controller:"SearchCtrl",controllerAs:"sc"}).when("/search",{templateUrl:"views/search.html",controller:"SearchCtrl",controllerAs:"sc"}).when("/drugStoreList/:cdprep/:cdform",{templateUrl:"views/drugStoreList.html",controller:"DrugStoreListCtrl",controllerAs:"dsc"}).otherwise({redirectTo:"/search"})}])}(),function(){"use strict";function a(a,b){function c(b,c){f.emit("send_gridtable1",["",b,,,"все","все","","",,,,,,,,,"",""]),f.on("grid_data1",function(){var b=arguments;a.$apply(function(){c.apply(f,b)})})}function d(b,c){var d=["","",b.cdprep,b.cdform,"все","Все","","",,,,,,,,,"",""];f.emit("send_gridtable4",d),f.on("grid_data4",function(){var b=arguments;a.$apply(function(){c.apply(f,b)})})}var e={getDrugs:c,getDrugStoresByDrug:d},f=b.connect("http:inform-buro.info:80");return f.on("error",function(){console.log("there was an error")}),e}angular.module("informBuroApp.core",[]),angular.module("informBuroApp.core").value("$io",io).factory("webSocket",a),a.$inject=["$rootScope","$io"]}(),function(){"use strict";angular.module("informBuroApp.core").filter("encodeUri",function(){return function(a){return window.btoa(encodeURIComponent(a))}})}(),function(){"use strict";angular.module("informBuroApp.core").directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}})}(),function(){"use strict";function a(a,b){function c(){if(n.model={state:"list",order:{mode:"0",orderBy:"price",orderReverse:!1},drugStores:[]},b&&b.cdprep&&b.cdform){var c={cdprep:b.cdprep,cdform:b.cdform};n.model.drugStores=[],a.getDrugStoresByDrug(c,d)}}function d(a){n.model.drugStores=a,n.model.groupedDrugStores=e(a)}function e(a){for(var b,c,d={},e=[],f=0;f<a.length;f++)b=a[f],null==d[b.cdfirm]&&(d[b.cdfirm]=e.length),c=d[b.cdfirm],e[c]=e[c]||{cdfirm:b.cdfirm,map:b.map,nmfirm:b.nmfirm,phones:b.phones,str:b.str,time:b.time,products:[]},e[c].products.push({nmplant:b.nmplant,price:b.price});return e}function f(){$(window).resize(i),g(),j()}function g(){var a=["zoomControl","fullscreenControl","geolocationControl"];ymaps.geolocation.get({mapStateAutoApply:!0}).then(function(b){var c=$("#map"),d=b.geoObjects.get(0).properties.get("boundedBy"),e=ymaps.util.bounds.getCenterAndZoom(d,[c.width(),c.height()]);e.zoom=15,e.controls=a,l=l||h(e),p.proceedInit()},function(b){console.log(b),h({center:[55.751574,37.573856],zoom:2,controls:a})})}function h(a){return new ymaps.Map("map",a)}function i(){clearTimeout(m),m=setTimeout(j,250)}function j(){var a=$("#map:visible");if(!a.length)return void(o=!0);o=!1;var b=$(window).height()-a.position().top;a.css("height",b),l&&l.container.fitToViewport()}function k(){function a(a){for(var b="",c=0;c<a.length;c++)b+='<div><div class="b-map-balloon-price">'+a[c].price+" руб.</div>"+(a[c].nmplant?'<div class="b-map-balloon-oname">'+a[c].nmplant+"</div>":"")+"</div>";return b}function b(a){if(null==a)return null;if(!a.pos){var b=g.exec(a.map);b&&2==b.length&&(a.pos=$.parseJSON(b[1]),a.pos.lat=parseFloat(a.pos.lat),a.pos.lon=parseFloat(a.pos.lon))}return a.pos}function c(a,b){return a&&a.lat&&a.lon&&b&&2==b.length&&a.lat>b[0][0]&&a.lon>b[0][1]&&a.lat<b[1][0]&&a.lon<b[1][1]}function d(a){if(n.model&&n.model.drugStores&&a){var c,d=a.call(),e=!1;for(c=d;!e;){if(c>=0&&c<n.model.groupedDrugStores.length){var f=n.model.groupedDrugStores[c];b(f),f.pos&&f.pos.lat&&f.pos.lon&&(l.balloon.isOpen()&&l.balloon.close(),l.setCenter([f.pos.lat,f.pos.lon]),e=!0)}e||(c=a.call(),c==d&&(e=!0))}}}function e(){d(function(){return h++,h>=n.model.groupedDrugStores.length&&(h=0),h})}function f(){d(function(){return h--,0>h&&(h=n.model.groupedDrugStores.length-1),h})}var g=/"\\?pos\\?":({.*?})/gm,h=-1,i=20,j={load:function(){var a=l.getBounds();l.geoObjects.removeAll();for(var d=0,e=0;d<n.model.groupedDrugStores.length&&i>e;d++){var f=n.model.groupedDrugStores[d];if(b(f),c(f.pos,a)){var g=new ymaps.Placemark([f.pos.lat,f.pos.lon],{iconContent:++e,balloonContent:j.generateBalloonContent(f)},{preset:{openBaloonOnClick:!0,preset:"twirl#blueDotIcon"},balloonMaxWidth:400});l.geoObjects.add(g)}}},proceedInit:function(){var a=new ymaps.control.Button({data:{iconType:"prevDrugStore glyphicon glyphicon-triangle-left",title:"Предыдущая аптека"},options:{selectOnClick:!1,"float":"right"}}),b=new ymaps.control.Button({data:{iconType:"prevDrugStore glyphicon glyphicon-triangle-right",title:"Следующая аптека"},options:{selectOnClick:!1,"float":"right"}});a.events.add("click",f),b.events.add("click",e),l.controls.add(a).add(b),j.load(),l.events.add("boundschange",function(){l.balloon.isOpen()||j.load()})},generateBalloonContent:function(b){return a(b.products)+'<div class="b-map-balloon-shopname">'+b.nmfirm+'</div><div class="b-map-balloon-worktime">'+b.time+'</div><div class="b-map-balloon-addr">'+b.str+"</div>"}};return j}var l,m,n=this,o=!0,p=k();c(),n.orderChanged=function(){switch(n.model.order.mode){case"0":n.model.order.orderBy="price",n.model.order.orderReverse=!1;break;case"1":n.model.order.orderBy="price",n.model.order.orderReverse=!0}},n.showMap=function(){n.model.state="maps",!l&&ymaps&&ymaps.ready(f),o&&setTimeout(j,1)}}angular.module("informBuroApp").controller("DrugStoreListCtrl",a),a.$inject=["webSocket","$routeParams"]}(),function(){"use strict";function a(a,b){function c(){if(b&&b.drug){var c=decodeURIComponent(b.drug);e.drugs=[],a.getDrugs(c,d)}}function d(a){e.drugs=$.grep(a,function(a){return a.prices})}var e=this;c(),e.getDrugOffersCount=function(a){if(!a)return"";var b=a.toString(),c=b.length?b[b.length-1]:"0",d=b.length>1?b[b.length-2]:"0",e="";if("1"==d||"5"===c||"6"===c||"7"===c||"8"===c||"9"===c||"0"===c)e="й";else if("1"===c)e="е";else{if("2"!==c&&"3"!==c&&"4"!==c)return"";e="я"}return a+" предложени"+e}}angular.module("informBuroApp").controller("SearchCtrl",a),a.$inject=["webSocket","$routeParams"]}(),function(){"use strict";function a(a,b){function c(){d.searchText="",b.drug&&(d.searchText=decodeURIComponent(b.drug))}var d=this;c(),d.search=function(){d.searchText&&a.path("/search/"+encodeURIComponent(d.searchText))}}angular.module("informBuroApp").controller("SearchPanelCtrl",a),a.$inject=["$location","$routeParams"]}();
//# sourceMappingURL=app.min.js.map